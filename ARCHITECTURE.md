# 🏗️ Архитектура ИИ-Ассистента

## 🎯 **Что это за проект?**

Это **личный помощник в Telegram**, который:
- Понимает обычную речь (по-русски и по-английски)
- Управляет твоим календарём
- Работает с контактами
- Анализирует Excel файлы
- Запоминает всё о тебе
- Доступен 24/7 через Telegram

---

## 🏗️ **АРХИТЕКТУРА ПРОЕКТА (большая картина)**

```
┌─────────────────────────────────────────────────────────────────┐
│                         ИНТЕРФЕЙС                                │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              📱 TELEGRAM (твой телефон)                    │  │
│  │                                                             │  │
│  │  Ты: "Создай встречу завтра в 3"                          │  │
│  │  Бот: "✅ Встреча создана на 23.12 в 15:00"               │  │
│  └───────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │ Интернет
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ТВОЙ КОМПЬЮТЕР / СЕРВЕР                       │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    BOT.PY (главный файл)                  │   │
│  │              "Запускает всё и управляет"                  │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                            │                                      │
│                            ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              BOT HANDLER (мозг операций)                  │   │
│  │                                                            │   │
│  │  1. Получает сообщение                                    │   │
│  │  2. Проверяет: это ты?                                    │   │
│  │  3. Загружает память                                      │   │
│  │  4. Думает что делать                                     │   │
│  │  5. Выполняет действие                                    │   │
│  │  6. Отвечает тебе                                         │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                            │                                      │
│         ┌──────────────────┼──────────────────┐                  │
│         │                  │                  │                  │
│         ▼                  ▼                  ▼                  │
│  ┌──────────┐      ┌─────────────┐    ┌──────────────┐         │
│  │ SECURITY │      │  LLM CLIENT │    │   MODULES    │         │
│  │          │      │             │    │              │         │
│  │ • Проверка│     │ • ChatGPT   │    │ • Календарь  │         │
│  │ • Лимиты  │     │ • Claude    │    │ • Контакты   │         │
│  │ • Валидация│    │ • Retry     │    │ • Excel      │         │
│  └──────────┘      └─────────────┘    │ • Память     │         │
│                            │           └──────┬───────┘         │
│                            │                  │                  │
│                            ▼                  ▼                  │
│                    ┌────────────────────────────┐               │
│                    │    DATABASE (SQLite)       │               │
│                    │                            │               │
│                    │  • Разговоры (🔒)         │               │
│                    │  • Предпочтения (🔒)      │               │
│                    │  • События (🔒)           │               │
│                    │  • Контакты (🔒)          │               │
│                    └────────────────────────────┘               │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ВНЕШНИЕ СЕРВИСЫ (облако)                      │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   OpenAI     │  │ Apple iCloud │  │Google Calendar│          │
│  │   (ChatGPT)  │  │  (календарь) │  │  (календарь)  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 **КАК ЭТО РАБОТАЕТ ПОШАГОВО**

### **Сценарий: Ты создаёшь встречу**

```
ШАГ 1: ТЫ ПИШЕШЬ БОТУ
┌────────────────────────────────┐
│  Telegram на твоём телефоне    │
│                                │
│  Ты → "Создай встречу с        │
│        Иваном завтра в 3"      │
└────────────────┬───────────────┘
                 │
                 │ Интернет
                 ▼

ШАГ 2: TELEGRAM ПЕРЕДАЁТ СООБЩЕНИЕ
┌────────────────────────────────┐
│   Telegram Servers             │
│   (облако Telegram)            │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 3: БОТ ПОЛУЧАЕТ СООБЩЕНИЕ
┌────────────────────────────────┐
│  bot.py на твоём компьютере    │
│                                │
│  Получено: "Создай встречу..." │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 4: ПРОВЕРКА БЕЗОПАСНОСТИ
┌────────────────────────────────┐
│  Security Check                │
│                                │
│  ✓ Это разрешённый user?       │
│  ✓ Не слишком много запросов?  │
│  ✓ Сообщение безопасно?        │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 5: ЗАГРУЗКА ПАМЯТИ
┌────────────────────────────────┐
│  Memory Manager                │
│                                │
│  Загружает из базы:            │
│  • Последние 20 сообщений      │
│  • Твои предпочтения           │
│  • Контекст о тебе             │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 6: ОТПРАВКА В CHATGPT
┌────────────────────────────────┐
│  OpenAI API (ChatGPT)          │
│                                │
│  Бот отправляет:               │
│  "Пользователь сказал:         │
│   'Создай встречу с Иваном     │
│    завтра в 3'                 │
│                                │
│   Что это значит?"             │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 7: CHATGPT АНАЛИЗИРУЕТ
┌────────────────────────────────┐
│  ChatGPT думает:               │
│                                │
│  "Завтра в 3" = 15:00          │
│  "с Иваном" = название         │
│  Действие: создать событие     │
│                                │
│  Ответ: "Используй модуль      │
│  календаря с параметрами:      │
│  - title: 'Встреча с Иваном'   │
│  - date: завтра                │
│  - time: 15:00"                │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 8: ВЫПОЛНЕНИЕ ДЕЙСТВИЯ
┌────────────────────────────────┐
│  Calendar Module               │
│                                │
│  create_event(                 │
│    title="Встреча с Иваном",   │
│    date=tomorrow,              │
│    time="15:00"                │
│  )                             │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 9: СОХРАНЕНИЕ В КАЛЕНДАРЬ
┌────────────────────────────────┐
│  Провайдер календаря:          │
│  • Apple Calendar (iCloud)     │
│  • Google Calendar             │
│  • Локальная база              │
│                                │
│  ✅ Событие создано!           │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 10: СОХРАНЕНИЕ В ПАМЯТЬ
┌────────────────────────────────┐
│  Database (SQLite)             │
│                                │
│  Сохраняет (зашифровано):      │
│  • Твой вопрос                 │
│  • Ответ бота                  │
│  • Метаданные                  │
└────────────────┬───────────────┘
                 │
                 ▼

ШАГ 11: ОТВЕТ ТЕБЕ
┌────────────────────────────────┐
│  Telegram на твоём телефоне    │
│                                │
│  Бот → "✅ Встреча 'Встреча    │
│         с Иваном' создана на   │
│         23 декабря в 15:00"    │
└────────────────────────────────┘

⏱️ ВРЕМЯ: ~3 секунды
```

---

## 🧩 **КЛЮЧЕВЫЕ КОМПОНЕНТЫ (детально)**

### **1. Telegram Bot (интерфейс)**
```
┌───────────────────────────────┐
│     TELEGRAM BOT API          │
│                               │
│  Функции:                     │
│  • Получать сообщения         │
│  • Отправлять ответы          │
│  • Получать файлы             │
│  • Отправлять уведомления     │
│                               │
│  Библиотека:                  │
│  python-telegram-bot 22.3     │
└───────────────────────────────┘
```

**Простыми словами:** Это как мессенджер между тобой и программой.

---

### **2. Bot Handler (мозг системы)**
```
┌───────────────────────────────┐
│      BOT HANDLER              │
│                               │
│  Отвечает за:                 │
│  ✓ Приём сообщений            │
│  ✓ Проверку доступа           │
│  ✓ Загрузку контекста         │
│  ✓ Вызов нужных модулей       │
│  ✓ Формирование ответов       │
│                               │
│  Файл: bot_handler.py         │
└───────────────────────────────┘
```

**Простыми словами:** Главный координатор, который решает что делать с твоим запросом.

---

### **3. LLM Client (понимание языка)**
```
┌───────────────────────────────┐
│       LLM CLIENT              │
│                               │
│  Primary: ChatGPT             │
│  • Модель: gpt-4o-mini        │
│  • Стоимость: $0.15/1000 зап. │
│  • Скорость: 1-2 сек          │
│                               │
│  Fallback: Claude             │
│  • Если ChatGPT недоступен    │
│  • Автоматическое переключение│
│                               │
│  Функции:                     │
│  • Понимание естественного    │
│    языка                      │
│  • Извлечение параметров      │
│  • Генерация ответов          │
└───────────────────────────────┘
```

**Простыми словами:** Переводчик между твоими словами и командами программы.

**Пример:**
```
Ты говоришь: "Создай встречу завтра в 3"
                    ↓
ChatGPT понимает: {
  action: "create_event",
  title: "Встреча",
  date: "2025-12-23",
  time: "15:00"
}
                    ↓
Программа выполняет: create_event(...)
```

---

### **4. Security (защита)**
```
┌───────────────────────────────┐
│       SECURITY LAYER          │
│                               │
│  1. Input Validator           │
│     • Проверка на SQL inject  │
│     • Фильтр опасных символов │
│     • Лимит длины сообщений   │
│                               │
│  2. Rate Limiter              │
│     • 30 сообщений/минута     │
│     • Защита от перегрузки    │
│                               │
│  3. Access Control            │
│     • Белый список user IDs   │
│     • Только ты можешь юзать  │
│                               │
│  4. Encryption                │
│     • AES-256 шифрование      │
│     • Все данные зашифрованы  │
└───────────────────────────────┘
```

**Простыми словами:** Охрана, которая следит чтобы никто чужой не залез и ничего не сломал.

---

### **5. Modules (функциональность)**

#### **📅 Calendar Module**
```
┌───────────────────────────────┐
│     CALENDAR MODULE           │
│                               │
│  Может:                       │
│  • Создавать события          │
│  • Редактировать события      │
│  • Удалять события            │
│  • Показывать расписание      │
│  • Искать свободное время     │
│                               │
│  Поддерживает:                │
│  ✓ Apple Calendar (CalDAV)    │
│  ✓ Google Calendar (API)      │
│  ✓ Microsoft Outlook (Graph)  │
│  ✓ Локальное хранилище        │
└───────────────────────────────┘
```

#### **👥 Contacts Module**
```
┌───────────────────────────────┐
│     CONTACTS MODULE           │
│                               │
│  Может:                       │
│  • Добавлять контакты         │
│  • Редактировать контакты     │
│  • Искать контакты            │
│  • Напоминать о днях рождения │
│                               │
│  Поддерживает:                │
│  ✓ iCloud Contacts (CardDAV)  │
│  ✓ Google Contacts (People API)│
│  ✓ Microsoft Contacts (Graph) │
│  ✓ Локальное хранилище        │
└───────────────────────────────┘
```

#### **📊 Excel Module**
```
┌───────────────────────────────┐
│      EXCEL MODULE             │
│                               │
│  Может:                       │
│  • Читать .xlsx файлы         │
│  • Анализировать данные       │
│  • Считать суммы/средние      │
│  • Строить простые графики    │
│  • Отвечать на вопросы о      │
│    данных                     │
│                               │
│  Лимит: 10MB файл             │
└───────────────────────────────┘
```

#### **🧠 Memory Module**
```
┌───────────────────────────────┐
│      MEMORY MODULE            │
│                               │
│  Хранит:                      │
│  • Последние 20 сообщений     │
│  • Твои предпочтения          │
│  • Важные факты о тебе        │
│  • Контекст разговоров        │
│                               │
│  Защита от race conditions:   │
│  • asyncio.Lock для каждого   │
│    пользователя               │
└───────────────────────────────┘
```

**Простыми словами:** Набор инструментов, которыми бот пользуется для выполнения задач.

---

### **6. Database (хранилище)**
```
┌───────────────────────────────┐
│      DATABASE (SQLite)        │
│                               │
│  Таблицы:                     │
│  ┌─────────────────────────┐  │
│  │ users                   │  │
│  │ • id                    │  │
│  │ • preferences (JSON)    │  │
│  │ • created_at            │  │
│  └─────────────────────────┘  │
│                               │
│  ┌─────────────────────────┐  │
│  │ conversations           │  │
│  │ • user_id               │  │
│  │ • user_message (🔒)     │  │
│  │ • assistant_message (🔒)│  │
│  │ • timestamp             │  │
│  └─────────────────────────┘  │
│                               │
│  ┌─────────────────────────┐  │
│  │ calendar_events         │  │
│  │ • title (🔒)            │  │
│  │ • date                  │  │
│  │ • time                  │  │
│  └─────────────────────────┘  │
│                               │
│  ┌─────────────────────────┐  │
│  │ contacts                │  │
│  │ • name (🔒)             │  │
│  │ • phone (🔒)            │  │
│  │ • email (🔒)            │  │
│  └─────────────────────────┘  │
│                               │
│  🔒 = Зашифровано AES-256     │
└───────────────────────────────┘
```

**Простыми словами:** Цифровая записная книжка, где всё зашифровано.

---

## 📂 **СТРУКТУРА ПРОЕКТА (файлы и папки)**

```
my-first-project/
│
├── 📄 bot.py                    ← Главный файл (запуск бота)
├── 📄 config.py                 ← Настройки
├── 📄 .env                      ← СЕКРЕТНЫЕ КЛЮЧИ (не коммитить!)
├── 📄 requirements.txt          ← Список библиотек
├── 📄 README.md                 ← Инструкция
│
├── 📁 src/                      ← Весь код здесь
│   │
│   ├── 📁 core/                 ← Ядро системы
│   │   ├── bot_handler.py      ← Главный обработчик
│   │   ├── error_handler.py    ← Обработка ошибок
│   │   ├── rate_limiter.py     ← Защита от спама
│   │   └── logger.py           ← Логирование
│   │
│   ├── 📁 llm/                  ← Работа с ИИ
│   │   ├── openai_client.py    ← ChatGPT
│   │   ├── claude_client.py    ← Claude (запасной)
│   │   └── retry.py            ← Повтор при ошибке
│   │
│   ├── 📁 providers/            ← Календари и контакты
│   │   ├── 📁 calendar/
│   │   │   ├── base.py         ← Общий интерфейс
│   │   │   ├── apple.py        ← Apple Calendar
│   │   │   ├── google.py       ← Google Calendar
│   │   │   └── local.py        ← Локальный
│   │   │
│   │   └── 📁 contacts/
│   │       ├── base.py
│   │       ├── apple.py
│   │       ├── google.py
│   │       └── local.py
│   │
│   ├── 📁 modules/              ← Дополнительные функции
│   │   ├── excel_handler.py    ← Работа с Excel
│   │   ├── pdf_handler.py      ← Работа с PDF
│   │   └── image_handler.py    ← Работа с картинками
│   │
│   ├── 📁 database/             ← База данных
│   │   ├── models.py           ← Структура таблиц
│   │   ├── connection.py       ← Подключение к БД
│   │   ├── encryption.py       ← Шифрование
│   │   └── migrations.py       ← Обновления структуры
│   │
│   ├── 📁 memory/               ← Система памяти
│   │   ├── manager.py          ← Управление памятью
│   │   └── storage.py          ← Хранилище
│   │
│   ├── 📁 security/             ← Безопасность
│   │   ├── input_validator.py  ← Проверка входных данных
│   │   └── secrets.py          ← Управление секретами
│   │
│   └── 📁 utils/                ← Утилиты
│       ├── helpers.py
│       ├── constants.py
│       └── i18n.py             ← Переводы
│
├── 📁 data/                     ← Данные (НЕ коммитить!)
│   ├── database.db             ← База данных (зашифрована)
│   ├── 📁 logs/                ← Логи
│   └── 📁 user_files/          ← Загруженные файлы
│
├── 📁 tests/                    ← Тесты
│   ├── test_bot.py
│   ├── test_llm.py
│   └── test_modules.py
│
├── 📁 scripts/                  ← Полезные скрипты
│   ├── setup.sh                ← Первая настройка
│   ├── backup.sh               ← Создание бэкапов
│   └── health_check.py         ← Проверка здоровья
│
└── 📁 docs/                     ← Документация
    ├── AI_ASSISTANT_PROJECT.md ← Техническое описание
    ├── stack.md                ← Инструменты и бюджет
    ├── HOW_IT_WORKS.md         ← Как работает
    └── ARCHITECTURE.md         ← Этот файл
```

---

## 💰 **СТОИМОСТЬ (что за что платим)**

### **Минимальная конфигурация: $10-15/мес**

```
┌──────────────────────────────────┐
│  ОБЯЗАТЕЛЬНО:                    │
│  OpenAI API (gpt-4o-mini)        │
│  • $10-15/мес                    │
│  • За 1000 запросов = $0.15      │
│  • Это "мозг" бота               │
└──────────────────────────────────┘

┌──────────────────────────────────┐
│  БЕСПЛАТНО:                      │
│  ✅ Telegram Bot                  │
│  ✅ Python                        │
│  ✅ SQLite база данных            │
│  ✅ Локальный запуск              │
│  ✅ Apple/Google календарь        │
│  ✅ Git + GitHub                  │
└──────────────────────────────────┘

┌──────────────────────────────────┐
│  ОПЦИОНАЛЬНО:                    │
│  Облачный сервер (VPS)           │
│  • $0 (локально на ПК)           │
│  • ИЛИ $4-6/мес (сервер 24/7)    │
│  • Hetzner/DigitalOcean          │
└──────────────────────────────────┘
```

**ИТОГО:** От $10/мес до $20/мес

---

## 🚀 **КАК ЗАПУСТИТЬ (5 шагов)**

### **Шаг 1: Получить ключи**
```
1. Telegram Bot Token:
   • Открыть @BotFather в Telegram
   • Команда: /newbot
   • Получить токен

2. OpenAI API Key:
   • Зайти на platform.openai.com
   • Создать аккаунт
   • Добавить карту
   • Получить API ключ
   • Установить лимит $20/мес
```

### **Шаг 2: Скачать код**
```bash
git clone <репозиторий>
cd my-first-project
```

### **Шаг 3: Установить зависимости**
```bash
python -m venv venv
source venv/bin/activate  # Mac/Linux
pip install -r requirements.txt
```

### **Шаг 4: Создать .env файл**
```bash
# Скопировать шаблон
cp .env.example .env

# Отредактировать и вставить свои ключи
TELEGRAM_BOT_TOKEN=твой_токен
OPENAI_API_KEY=твой_ключ
CALENDAR_PROVIDER=local
```

### **Шаг 5: Запустить бота**
```bash
python bot.py
```

**Готово!** Пиши боту в Telegram 🎉

---

## ✨ **ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ**

### **Пример 1: Управление календарём**
```
Ты:  Что у меня завтра?
Бот: 📅 На 23 декабря:
     • 10:00 Встреча с командой
     • 14:00 Обед с клиентом
     • 17:00 Звонок

Ты:  Создай тренировку в 12:30
Бот: ✅ Тренировка создана на 12:30

Ты:  Когда у меня свободное время?
Бот: Свободные окна:
     • 12:00-14:00 (2 часа)
     • 15:00-17:00 (2 часа)
```

### **Пример 2: Работа с Excel**
```
Ты:  (отправляешь расходы.xlsx)
     Проанализируй расходы

Бот: 📊 Анализ за декабрь:
     Всего: 78,450₽

     По категориям:
     🍔 Еда: 28,000₽ (36%)
     🚗 Транспорт: 15,500₽ (20%)
     🏠 Жильё: 25,000₽ (32%)

     ⚠️ Превышение бюджета: 4,950₽

Ты:  Запомни что мой бюджет 50,000
Бот: 🧠 Запомнил!
```

### **Пример 3: Память и контекст**
```
День 1:
Ты:  Я вегетарианец
Бот: Запомнил!

День 3:
Ты:  Посоветуй ресторан
Бот: Рекомендую вегетарианское кафе "Зелёный лист"
     (учитывая что вы вегетарианец)
```

---

## 🔒 **БЕЗОПАСНОСТЬ**

### **Что защищено:**

1. **Данные в базе** - AES-256 шифрование
2. **API ключи** - никогда не в логах
3. **Доступ к боту** - только белый список пользователей
4. **Входные данные** - валидация и санитизация
5. **Rate limiting** - защита от спама

### **Как работает шифрование:**
```
Обычный текст: "Встреча с Иваном в 15:00"
        ↓
   ШИФРОВАНИЕ (AES-256)
        ↓
В базе данных: "a8f3k2m9x7..." (нечитаемо)
        ↓
   РАСШИФРОВКА
        ↓
Бот читает: "Встреча с Иваном в 15:00"
```

---

## 🎯 **СЛЕДУЮЩИЕ ШАГИ**

Теперь ты понимаешь всю архитектуру! Можно:

1. **Создать структуру проекта** - все файлы и папки
2. **Написать базовый код** - минимальный рабочий бот
3. **Настроить окружение** - зависимости и конфиг
4. **Запустить первую версию** - твой личный ассистент

**Что делаем дальше?** 🚀
